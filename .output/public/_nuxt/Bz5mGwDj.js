import{Q as N,g as S,R as P,G as L,S as M,T as _,L as B,H as x,P as R,p as O}from"./CCeOfYC8.js";import{i as U}from"./BJ2ClxiI.js";function z(e,o){if(typeof e!="string")throw new TypeError("argument str must be a string");const t={},r=o||{},c=r.decode||F;let s=0;for(;s<e.length;){const a=e.indexOf("=",s);if(a===-1)break;let f=e.indexOf(";",s);if(f===-1)f=e.length;else if(f<a){s=e.lastIndexOf(";",a-1)+1;continue}const l=e.slice(s,a).trim();if(r?.filter&&!r?.filter(l)){s=f+1;continue}if(t[l]===void 0){let d=e.slice(a+1,f).trim();d.codePointAt(0)===34&&(d=d.slice(1,-1)),t[l]=H(d,c)}s=f+1}return t}function F(e){return e.includes("%")?decodeURIComponent(e):e}function H(e,o){try{return o(e)}catch{return e}}const C=/^[\u0009\u0020-\u007E\u0080-\u00FF]+$/;function I(e,o,t){const r=t||{},c=r.encode||encodeURIComponent;if(typeof c!="function")throw new TypeError("option encode is invalid");if(!C.test(e))throw new TypeError("argument name is invalid");const s=c(o);if(s&&!C.test(s))throw new TypeError("argument val is invalid");let a=e+"="+s;if(r.maxAge!==void 0&&r.maxAge!==null){const f=r.maxAge-0;if(Number.isNaN(f)||!Number.isFinite(f))throw new TypeError("option maxAge is invalid");a+="; Max-Age="+Math.floor(f)}if(r.domain){if(!C.test(r.domain))throw new TypeError("option domain is invalid");a+="; Domain="+r.domain}if(r.path){if(!C.test(r.path))throw new TypeError("option path is invalid");a+="; Path="+r.path}if(r.expires){if(!G(r.expires)||Number.isNaN(r.expires.valueOf()))throw new TypeError("option expires is invalid");a+="; Expires="+r.expires.toUTCString()}if(r.httpOnly&&(a+="; HttpOnly"),r.secure&&(a+="; Secure"),r.priority)switch(typeof r.priority=="string"?r.priority.toLowerCase():r.priority){case"low":{a+="; Priority=Low";break}case"medium":{a+="; Priority=Medium";break}case"high":{a+="; Priority=High";break}default:throw new TypeError("option priority is invalid")}if(r.sameSite)switch(typeof r.sameSite=="string"?r.sameSite.toLowerCase():r.sameSite){case!0:{a+="; SameSite=Strict";break}case"lax":{a+="; SameSite=Lax";break}case"strict":{a+="; SameSite=Strict";break}case"none":{a+="; SameSite=None";break}default:throw new TypeError("option sameSite is invalid")}return r.partitioned&&(a+="; Partitioned"),a}function G(e){return Object.prototype.toString.call(e)==="[object Date]"||e instanceof Date}function v(e){if(typeof e!="object")return e;var o,t,r=Object.prototype.toString.call(e);if(r==="[object Object]"){if(e.constructor!==Object&&typeof e.constructor=="function"){t=new e.constructor;for(o in e)e.hasOwnProperty(o)&&t[o]!==e[o]&&(t[o]=v(e[o]))}else{t={};for(o in e)o==="__proto__"?Object.defineProperty(t,o,{value:v(e[o]),configurable:!0,enumerable:!0,writable:!0}):t[o]=v(e[o])}return t}if(r==="[object Array]"){for(o=e.length,t=Array(o);o--;)t[o]=v(e[o]);return t}return r==="[object Set]"?(t=new Set,e.forEach(function(c){t.add(v(c))}),t):r==="[object Map]"?(t=new Map,e.forEach(function(c,s){t.set(v(s),v(c))}),t):r==="[object Date]"?new Date(+e):r==="[object RegExp]"?(t=new RegExp(e.source,e.flags),t.lastIndex=e.lastIndex,t):r==="[object DataView]"?new e.constructor(v(e.buffer)):r==="[object ArrayBuffer]"?e.slice(0):r.slice(-6)==="Array]"?new e.constructor(e):e}const V={path:"/",watch:!0,decode:e=>N(decodeURIComponent(e)),encode:e=>encodeURIComponent(typeof e=="string"?e:JSON.stringify(e))},E=window.cookieStore;function k(e,o){const t={...V,...o};t.filter??=d=>d===e;const r=D(t)||{};let c;t.maxAge!==void 0?c=t.maxAge*1e3:t.expires&&(c=t.expires.getTime()-Date.now());const s=c!==void 0&&c<=0,a=s||r[e]===void 0||r[e]===null,f=v(s?void 0:r[e]??t.default?.()),l=c&&!s?Q(f,c,t.watch&&t.watch!=="shallow"):S(f);{let d=null;try{!E&&typeof BroadcastChannel<"u"&&(d=new BroadcastChannel(`nuxt:cookies:${e}`))}catch{}const p=(h=!1)=>{!h&&(t.readonly||U(l.value,r[e]))||(J(e,l.value,t),r[e]=v(l.value),d?.postMessage({value:t.encode(l.value)}))},m=h=>{const w=h.refresh?D(t)?.[e]:t.decode(h.value);y=!0,l.value=w,r[e]=v(w),B(()=>{y=!1})};let y=!1;const g=!!M();if(g&&P(()=>{y=!0,p(),d?.close()}),E){const h=w=>{const T=w.changed.find(b=>b.name===e),A=w.deleted.find(b=>b.name===e);T&&m({value:T.value}),A&&m({value:null})};E.addEventListener("change",h),g&&P(()=>E.removeEventListener("change",h))}else d&&(d.onmessage=({data:h})=>m(h));t.watch&&L(l,()=>{y||p()},{deep:t.watch!=="shallow"}),a&&p(a)}return l}function D(e={}){return z(document.cookie,e)}function q(e,o,t={}){return o==null?I(e,o,{...t,maxAge:-1}):I(e,o,t)}function J(e,o,t={}){document.cookie=q(e,o,t)}const $=2147483647;function Q(e,o,t){let r,c,s=0;const a=t?S(e):{value:e};return M()&&P(()=>{c?.(),clearTimeout(r)}),_((f,l)=>{t&&(c=L(a,l));function d(){s=0,clearTimeout(r);const p=o-s,m=p<$?p:$;r=setTimeout(()=>{if(s+=m,s<o)return d();a.value=void 0,l()},m)}return{get(){return f(),a.value},set(p){d(),a.value=p,l()}}})}function K(){const e=S(null),o=S(!1),t=S(null),r=x(()=>!!e.value),c=i=>e.value?.permissions?e.value.permissions.includes(i)||e.value.permissions.includes("admin"):!1,s=x(()=>r.value),a=i=>e.value?e.value.id===i||c("moderate_reviews"):!1,f=i=>e.value?e.value.id===i||c("moderate_reviews"):!1,l=()=>k("auth-token",{default:()=>null,secure:!0,sameSite:"lax"}).value,d=(i,n=!1)=>{const u=k("auth-token",{default:()=>null,secure:!0,sameSite:"lax",maxAge:n?2592e3:86400});u.value=i},p=()=>{const i=k("auth-token");i.value=null},m=async i=>{o.value=!0,t.value=null;try{const n=await $fetch("/api/auth/login",{method:"POST",body:i});if(n.success&&n.data){if(e.value=n.data.user,d(n.data.token,i.remember),n.data.refreshToken){const u=k("refresh-token",{secure:!0,sameSite:"lax",maxAge:2592e3});u.value=n.data.refreshToken}await O("/reviews")}return n}catch(n){const u=n.response?.data?.error?.message||"Login failed";return t.value=u,{success:!1,error:{code:n.response?.data?.error?.code||"LOGIN_ERROR",message:u,field:n.response?.data?.error?.field}}}finally{o.value=!1}},y=async i=>{o.value=!0,t.value=null;try{const n=await $fetch("/api/auth/register",{method:"POST",body:i});return n.success&&n.data&&(e.value=n.data.user,d(n.data.token),await O("/reviews")),n}catch(n){const u=n.response?.data?.error?.message||"Registration failed";return t.value=u,{success:!1,error:{code:n.response?.data?.error?.code||"REGISTER_ERROR",message:u,field:n.response?.data?.error?.field}}}finally{o.value=!1}},g=async()=>{o.value=!0;try{await $fetch("/api/auth/logout",{method:"POST",headers:{Authorization:`Bearer ${l()}`}})}catch(i){console.warn("Server logout failed:",i)}finally{e.value=null,p();const i=k("refresh-token");i.value=null,o.value=!1,await O("/login")}},h=async()=>{const i=l();if(!i)return null;o.value=!0,t.value=null;try{const n=await $fetch("/api/auth/profile",{headers:{Authorization:`Bearer ${i}`}});return n.success?(e.value=n.data,n.data):null}catch(n){return n.response?.status===401?await g():t.value="Failed to fetch profile",null}finally{o.value=!1}},w=async i=>{const n=l();if(!n)return!1;o.value=!0,t.value=null;try{const u=await $fetch("/api/auth/profile",{method:"PUT",headers:{Authorization:`Bearer ${n}`},body:i});return u.success?(e.value=u.data,!0):!1}catch(u){return t.value=u.response?.data?.error?.message||"Failed to update profile",!1}finally{o.value=!1}},T=async(i,n)=>{const u=l();if(!u)return!1;o.value=!0,t.value=null;try{return(await $fetch("/api/auth/change-password",{method:"POST",headers:{Authorization:`Bearer ${u}`},body:{currentPassword:i,newPassword:n}})).success}catch(j){return t.value=j.response?.data?.error?.message||"Failed to change password",!1}finally{o.value=!1}},A=async()=>{const n=k("refresh-token").value;if(!n)return!1;try{const u=await $fetch("/api/auth/refresh",{method:"POST",body:{refreshToken:n}});return u.success&&u.data?(d(u.data.token),e.value=u.data.user,!0):!1}catch{return await g(),!1}},b=async()=>{l()&&(await h()||await A()||p())};return{user:R(e),loading:R(o),error:R(t),isAuthenticated:r,hasPermission:c,canCreateReview:s,canEditReview:a,canDeleteReview:f,login:m,register:y,logout:g,fetchProfile:h,updateProfile:w,changePassword:T,getAuthToken:l,refreshAuthToken:A,initAuth:b}}export{K as u};
