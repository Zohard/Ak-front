import Q from"./2MIT5xPl.js";import{f as ee,g as p,h as N,G as te,Y as re,c,a as o,n as b,z as ae,A as ne,k as a,ac as C,J as oe,F as D,l as J,d as se,t as x,o as s,B as le,m as ce,y as ie,p as E,j as de}from"./CCeOfYC8.js";import{u as ue}from"./B9jFdIe5.js";const me={class:"relative group"},pe=["placeholder"],fe={class:"absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center gap-1"},ve={key:0,class:"text-xs text-primary-500"},he={key:2,class:"hidden sm:flex items-center gap-1 px-2 py-1 bg-background border border-border rounded-md text-xs text-text-muted"},ye={key:0,class:"absolute top-full left-0 right-0 mt-2 bg-surface border border-border rounded-xl shadow-card z-50 max-h-96 overflow-hidden backdrop-blur-sm"},xe={key:0,class:"p-3"},ge=["onClick"],be=["data-media-type"],ke={key:1,class:"w-12 h-16 bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-xs text-gray-500"},_e={class:"flex-1 min-w-0"},we={class:"font-medium text-text truncate mb-1"},Se={class:"flex items-center gap-3 text-sm text-text-secondary"},Ce={class:"px-2 py-0.5 bg-gray-100 dark:bg-gray-800 rounded text-xs capitalize"},$e={key:0},Re={key:1},Ie={key:1,class:"p-3"},Ue=["onClick"],Ee={class:"flex-1 text-text"},qe=["onClick"],Ae={key:2,class:"border-t border-border bg-background/50 backdrop-blur-sm p-3"},je=ee({__name:"SearchBar",props:{placeholder:{default:"Rechercher des animes, mangas..."},size:{default:"md"},showRecent:{type:Boolean,default:!0}},setup(K){const V=K,q=p(),A=p(),n=p(""),i=p([]),h=p(!1),_=p(!1),m=p(-1),$=p(!1),d=p([]);N(()=>{try{const e=localStorage.getItem("anime-kun-recent-searches");e&&(d.value=JSON.parse(e))}catch(e){console.warn("Failed to load recent searches:",e)}});let k=null,f=null,R=0;const B=async(e,t,u)=>{const r=new URLSearchParams;Object.entries(t).forEach(([U,g])=>{g!=null&&r.append(U,String(g))});const y=`${e}?${r.toString()}`,v=await fetch(y,{signal:u});if(!v.ok)throw new Error(`HTTP ${v.status}`);return v.json()},O=async e=>{if(!e||e.trim().length<3){f&&f.abort(),i.value=[],_.value=!1;return}f&&f.abort();const t=new AbortController;f=t;const u=++R;_.value=!0;try{const y=de().public.apiBase?.replace(/\/$/,"")||"",[v,U]=await Promise.all([B(`${y}/api/animes/autocomplete`,{q:e,limit:3},t.signal),B(`${y}/api/mangas/autocomplete`,{q:e,limit:3},t.signal)]);if(u!==R)return;const g=v.data||[],X=Array.isArray(g)?g.map(l=>({id:l.id||l.id_anime,titre:l.titre,type:"anime",annee:l.annee,moyenne_notes:l.moyenne_notes||l.moyennenotes,image:l.image})):[],z=U.data||[],Z=Array.isArray(z)?z.map(l=>({id:l.id||l.id_manga,titre:l.titre,type:"manga",annee:l.annee,moyenne_notes:l.moyenne_notes||l.moyennenotes,image:l.image})):[];i.value=[...X,...Z].slice(0,5)}catch(r){if(r?.name==="AbortError")return;console.error("Search autocomplete error:",r),i.value=[]}finally{u===R&&(_.value=!1)}};te(n,e=>{m.value=-1,k&&clearTimeout(k);const t=e;k=setTimeout(()=>O(t),250)},{flush:"post"});const H=()=>{h.value=!0,!n.value&&V.showRecent&&($.value=!0)},F=e=>{if(!i.value.length)return;const t=i.value.length-1;m.value+=e,m.value>t?m.value=0:m.value<0&&(m.value=t)},M=e=>{if(!e.trim())return;const t=[e,...d.value.filter(u=>u!==e)].slice(0,10);d.value=t;try{localStorage.setItem("anime-kun-recent-searches",JSON.stringify(t))}catch(u){console.warn("Failed to save recent searches:",u)}},P=()=>{d.value=[],localStorage.removeItem("anime-kun-recent-searches")},G=e=>{d.value=d.value.filter(t=>t!==e);try{localStorage.setItem("anime-kun-recent-searches",JSON.stringify(d.value))}catch(t){console.warn("Failed to update recent searches:",t)}},Y=e=>{n.value=e,h.value=!1,I()},T=e=>e.toLowerCase().replace(/[àáâãäå]/g,"a").replace(/[èéêë]/g,"e").replace(/[ìíîï]/g,"i").replace(/[òóôõö]/g,"o").replace(/[ùúûü]/g,"u").replace(/[ýÿ]/g,"y").replace(/[ñ]/g,"n").replace(/[ç]/g,"c").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),j=e=>{if(n.value=e.titre,h.value=!1,e.type==="anime"){const t=e.niceUrl||T(e.titre||e.title);E(`/anime/${t}-${e.id}`)}else if(e.type==="manga"){const t=e.niceUrl||T(e.titre||e.title);E(`/manga/${t}-${e.id}`)}},L=()=>{n.value="",i.value=[],h.value=!1},I=()=>{if(n.value.trim()){if(m.value>=0&&i.value.length){j(i.value[m.value]);return}M(n.value.trim()),h.value=!1,$.value=!1,E(`/search?q=${encodeURIComponent(n.value)}`)}},{getImageUrl:W}=ue();let w=null,S=null;return N(()=>{w=e=>{(e.metaKey||e.ctrlKey)&&e.key==="k"&&(e.preventDefault(),A.value?.focus())},S=e=>{const t=e.target;q.value?.contains(t)||(h.value=!1)},document.addEventListener("keydown",w),document.addEventListener("click",S)}),re(()=>{w&&document.removeEventListener("keydown",w),S&&document.removeEventListener("click",S),k&&clearTimeout(k),f&&(f.abort(),f=null)}),(e,t)=>{const u=Q;return s(),c("div",{class:"relative w-full max-w-lg",ref_key:"searchContainer",ref:q},[o("div",me,[ae(o("input",{"onUpdate:modelValue":t[0]||(t[0]=r=>oe(n)?n.value=r:null),ref_key:"searchInput",ref:A,type:"text",placeholder:e.placeholder,class:"w-full pl-12 pr-12 py-3 bg-surface border border-border rounded-xl text-text placeholder-text-muted focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 hover:border-primary-400 transition-all duration-200 shadow-sm hover:shadow-md focus:shadow-lg",onFocus:H,onKeydown:[C(L,["escape"]),C(I,["enter"]),t[1]||(t[1]=C(r=>F(1),["arrow-down"])),t[2]||(t[2]=C(r=>F(-1),["arrow-up"]))]},null,40,pe),[[ne,a(n)]]),o("div",fe,[a(_)?(s(),c("span",ve,"...")):a(n)?(s(),c("button",{key:1,onClick:L,class:"p-1 rounded-full hover:bg-surface-hover text-text-muted hover:text-text transition-all duration-200"}," × ")):(s(),c("div",he,t[3]||(t[3]=[o("span",null,"⌘",-1),o("span",null,"K",-1)])))])]),a(h)&&(a(i).length||a(d).length)&&(a(n)||a($))?(s(),c("div",ye,[a(i).length&&a(n)?(s(),c("div",xe,[t[4]||(t[4]=o("div",{class:"text-xs font-medium text-text-muted mb-3 px-3"},"Résultats de recherche",-1)),(s(!0),c(D,null,J(a(i),(r,y)=>(s(),c("div",{key:`${r.type}-${r.id}`,class:le(["flex items-center p-3 rounded-lg cursor-pointer transition-all duration-200","hover:bg-surface-hover hover:shadow-sm",a(m)===y?"bg-primary-50 dark:bg-primary-900/20 ring-1 ring-primary-200 dark:ring-primary-800":""]),onClick:v=>j(r)},[o("div",{class:"w-12 h-16 mr-4 flex-shrink-0 rounded-lg overflow-hidden","data-media-type":r.type},[r.image?(s(),ce(u,{key:0,src:a(W)(r.image,r.type),alt:r.titre,"aspect-ratio":"3/4","container-class":"w-12 h-16","image-class":"w-full h-full object-cover","placeholder-icon":r.type==="anime"?"heroicons:tv":"heroicons:book-open"},null,8,["src","alt","placeholder-icon"])):(s(),c("div",ke,x(r.type),1))],8,be),o("div",_e,[o("div",we,x(r.titre),1),o("div",Se,[o("span",Ce,x(r.type),1),r.annee?(s(),c("span",$e,x(r.annee),1)):b("",!0),r.moyenne_notes?(s(),c("span",Re,x((r.moyenne_notes/10).toFixed(1)),1)):b("",!0)])])],10,ge))),128))])):b("",!0),a(d).length&&!a(n)?(s(),c("div",Ie,[o("div",{class:"text-xs font-medium text-text-muted mb-3 px-3 flex items-center justify-between"},[t[5]||(t[5]=se(" Recherches récentes ",-1)),o("button",{onClick:P,class:"text-primary-600 hover:text-primary-700 text-xs"}," Effacer tout ")]),(s(!0),c(D,null,J(a(d).slice(0,5),(r,y)=>(s(),c("div",{key:r,class:"flex items-center p-2 rounded-lg cursor-pointer hover:bg-surface-hover transition-colors duration-200",onClick:v=>Y(r)},[t[6]||(t[6]=o("span",{class:"text-text-muted mr-3"},"⏱",-1)),o("span",Ee,x(r),1),o("button",{onClick:ie(v=>G(r),["stop"]),class:"p-1 rounded hover:bg-surface-hover text-text-muted hover:text-text"}," × ",8,qe)],8,Ue))),128))])):b("",!0),a(n)?(s(),c("div",Ae,[o("button",{class:"w-full justify-center text-primary-600 hover:text-primary-700 hover:bg-primary-50 dark:hover:bg-primary-900/20 px-3 py-2 rounded",onClick:I},' Voir tous les résultats pour "'+x(a(n))+'" ',1)])):b("",!0)])):b("",!0)],512)}}});export{je as _};
